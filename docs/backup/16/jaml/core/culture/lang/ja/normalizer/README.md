# Japanese Normalizer

日本語特有の表記揺れや、Unicode標準の正規化（NFC等）では解決できない日本語固有の正規化処理を提供します。

## 概要

本モジュールは、`JapaneseRegExp` で定義された文字集合を利用し、日本語文書としての整合性を高めるための変換処理を担います。
全域的な `Unicode.normalize`（NFC）がCJK統合漢字の保護のために無効化されていることを補完し、安全に正規化できる範囲（仮名など）に限定して処理を行います。

## 仕様（実装予定の機能）

### 1. 濁点・半濁点の正規化 (Dakuten Normalization)
Unicode標準の正規化では扱われない「独立した濁点記号（U+309B）」等を用いた結合を、適切な統合文字または結合文字に変換します。

*   **ケースA（統合文字への変換）**: `か` + `゛`(U+309B) → `が`(U+304C)
*   **ケースB（結合文字への置換）**: `あ` + `゛`(U+309B) → `あ` + `゙`(U+3099)
    *   統合文字が存在しない場合は、Unicode標準の結合用濁点（U+3099）に置換することで、組版上の不具合を防ぎます。

### 2. 半角・全角の正規化 (Width Normalization)
オプションに基づき、半角カタカナや半角記号を全角に統一します。

*   **対象**: `JapaneseRegExp.JA.HALFWIDTH_KATAKANA`, `JapaneseRegExp.JA.HALFWIDTH_PUNCTUATION`
*   **変換**: `ｱ` → `ア`、`｡` → `。` 等。

### 3. 漢字の保護 (Ideograph Protection)
本モジュールで行う全ての正規化処理において、`JapaneseRegExp.JAML.NFC_UNSAFE` に該当する文字（異体字を含む漢字等）は、変換の対象から除外するか、あるいは字形が変化しないことを保証します。

## Usage (イメージ)

```javascript
import { JapaneseNormalizer } from './dist/main.js';

// 濁点の正規化
const text = "か" + "\u309B"; 
const result = JapaneseNormalizer.normalize(text);
// Result: "が"
```

## 責任分離に関する特記事項：JAMLプロパティの暫定配置について

`JapaneseRegExp.JAML` プロパティ（`RUBY_PARENT_KANJI`, `NFC_UNSAFE` 等）は、本来の設計思想に基づけば、以下のいずれかの機能層で定義されるべき性質のものです。

1.  **`core/culture/ja/`**: 日本語固有の正規化ロジックやサニタイズ要件に密接に関わるため。
2.  **`core/inline/ruby/`**: ルビの親文字判定という、特定の構文要素に依存する仕様であるため。

しかし、本プロジェクトの現段階においては、以下の理由から **`core/charset/unicode/regexp/ja/`** への暫定的な配置を決定しました。

*   **一括管理の利便性**: これらは全て正規表現（RegExp）による定義であり、他の日本語文字セット定義と物理的に近い場所で管理する方が、初期開発段階における見通しが良いため。
*   **将来のリファクタリングの布石**: 必要な文字集合の組み合わせをあらかじめ「要件」として明文化・コード化しておくことで、将来各機能層へ責任を移譲する際の仕様書としての役割を果たすため。

この配置は「意図的な責任分離の例外」であり、プロジェクトの成熟に伴い、適切なモジュールへと再配置されるべき技術負債として認識されています。





# Japanese Normalizer

日本語特有の表記揺れや、Unicode標準の正規化（NFC等）では解決できない、あるいは破壊されてしまう日本語固有の正規化処理を提供します。

## 概要

本モジュールは、`core/charset/unicode/regexp/ja` で定義された文字集合を利用し、日本語文書としての整合性を高めるための変換処理を担います。
全域的な `Unicode.normalize('NFC')` がCJK統合漢字の保護のために無効化されていることを補完し、**「漢字を保護しつつ、それ以外の部分を安全に正規化する」** ことを主目的とします。

## 仕様と機能

本モジュールは、`options` オブジェクトによって以下の機能の ON/OFF および変換方向を制御可能です。

### 1. NFC保護付き正規化 (Safe Normalization)
*   **機能**: 文書全体に対して `String.prototype.normalize('NFC')` を適用しますが、**異体字や意図的な結合文字（NFC_UNSAFE）は保護** します。
*   **ロジック**: テキストを「安全な部分（仮名、英数字等）」と「保護すべき部分（漢字、結合文字）」に分割し、安全な部分にのみ正規化を適用してから再結合します。

### 2. 濁点・半濁点の正規化 (Dakuten)
*   **独立記号の統合**: `か` + `゛`(U+309B) → `が`(U+304C)
*   **結合文字への統一**: `あ` + `゛` → `あ` + `゙`(U+3099) （統合文字が存在しない場合）

### 3. 半角・全角の相互変換 (Width)
*   **片仮名**: 半角カタカナを全角に変換、またはその逆。
*   **記号**: 半角記号（`｡`, `､`, `｢`, `｣`）を全角に変換、またはその逆。
*   **英数字**: 全角英数字を半角に変換、またはその逆。

### 4. 変体仮名の現代化 (Hentaigana)
*   **機能**: 変体仮名を、対応する現代の標準的な平仮名に変換します。
    *   例: `𛀓` (変体仮名) → `え`

### 5. 踊り字の展開 (Iteration Marks)
*   **機能**: 踊り字を、直前の文字を参照して展開します。
    *   例: `佐々木` → `佐佐木`
    *   例: `いゝ` → `いい`
    *   例: `みすゞ` → `みすず` (濁点付き)

### 6. 漢数字の変換 (Kansuji)
*   **機能**: 漢数字の「小字（一, 十）」と「大字（壱, 拾）」を相互変換します。
*   **デフォルト**: 大字 → 小字（正規化方向）。

### 7. 合字の相互変換 (Ligatures)
*   **機能**: 合字・略字を、対応する元の文字列に展開、またはその逆に変換します。
*   **対象**:
    *   **合略仮名**: `ゟ` → `より`、`ヿ` → `コト`
    *   **記号的略字**: `㍿` → `株式会社`
    *   **元号合字**: `㍻` → `平成`
    *   **単位合字**: `㌔` → `キロ`
`
### 8. 書字方向による記号変換 (Writing Mode)
*   **機能**: 横書き用記号と縦書き用記号を相互変換します。
    *   例: `「` (横書き) ↔ `﹁` (縦書き)
    *   例: `。` (横書き) ↔ `︒` (縦書き)

### ※助数詞用略字（`ヶ`, `ヵ`）について
本モジュールでは、助数詞として使われる `ヶ`、`ヵ`、`箇`、`か` 等の相互変換・正規化は **対象外** とします。

*   **理由**: 助数詞かどうかの文脈判定が極めて困難であるため。
*   **例**: 単純なパターンマッチ（`[漢字]+[か][漢字]+` 等）で正規化を行うと、「一か八か（いちかばちか）」のような慣用句まで「一ヶ八か」と誤変換され、意味が破壊されるリスクがあるためです。

## Usage

```javascript
import { JapaneseNormalizer } from './dist/main.js';

const text = "ｶﾞﾝﾀﾞﾑ\u309B"; // 半角カ + 濁点 + ... + 独立濁点
const options = {
    width: 'full',   // 全角統一
    dakuten: 'nfc',  // 統合文字優先
};

const normalized = JapaneseNormalizer.normalize(text, options);
// Result: "ガンダム"
```

